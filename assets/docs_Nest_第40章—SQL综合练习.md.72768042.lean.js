import{_ as s,v as a,b as n,R as l}from"./chunks/framework.eb2f4134.js";const i=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"docs/Nest/第40章—SQL综合练习.md","filePath":"docs/Nest/第40章—SQL综合练习.md"}'),p={name:"docs/Nest/第40章—SQL综合练习.md"},o=l(`<p>前面我们把 select、update、insert、delete 的语法、函数、关联查询、子查询都过了一遍，sql 学的就差不多了。</p><p>这节我们来实战下，写一些复杂的 sql。</p><p>先创建个单独的数据库：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">create</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">database</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">practice</span></span></code></pre></div><p>执行它： <img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-1.png" alt=""></p><p>点击刷新，就可以看到这个 database（也叫 schema）了：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-2.png" alt=""></p><p>执行 use practice 切换数据库：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">use</span><span style="color:#A6ACCD;"> practice;</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-3.png" alt=""></p><p>然后创建 3 个表：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 创建 customers 表，用于存储客户信息</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">customers</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户ID，自增长</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户姓名，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户信息表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 创建 orders 表，用于存储订单信息</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单ID，自增长</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">customer_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">客户ID，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_date</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">date</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单日期，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">total_amount</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">decimal</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单总金额，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FOREIGN KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">customer_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">REFERENCES</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">customers</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">ON DELETE CASCADE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> CASCADE</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单信息表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 创建 order_items 表，用于存储订单商品信息</span></span>
<span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">TABLE</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_items</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> AUTO_INCREMENT COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品ID，自增长</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单ID，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">product_name</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">varchar</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">255</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品名称，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">quantity</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">11</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品数量，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">price</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">decimal</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">NOT NULL</span><span style="color:#A6ACCD;"> COMMENT </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">商品单价，非空</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">PRIMARY KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">FOREIGN KEY</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">REFERENCES</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">) </span><span style="color:#C792EA;">ON DELETE CASCADE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> CASCADE</span></span>
<span class="line"><span style="color:#A6ACCD;">) ENGINE</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">InnoDB </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#A6ACCD;"> CHARSET</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">utf8mb4 COMMENT</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">订单商品信息表</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>分别是顾客、订单、订单项。</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-4.png" alt=""></p><p>一个顾客有多个订单，一个订单有多个订单项，通过外键存储这种关联关系。</p><p>级联方式为 CASCADE。</p><p>上面还涉及到注释的语法，sql 里的注释用 -- 开头：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-5.png" alt=""></p><p>执行建表 sql:</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-6.png" alt=""></p><p>点击刷新，就可以看到这三个表了：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-7.png" alt=""></p><p>然后插入一些数据：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- 向 customers 表插入数据</span></span>
<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">customers</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">) </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">VALUES</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张丽娜</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李明</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王磊</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">赵静</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">钱伟</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">孙芳</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">周涛</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">吴洋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">郑红</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">刘华</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">陈明</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">杨丽</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王磊</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张伟</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李娜</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">刘洋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">陈静</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">杨阳</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王丽</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">),(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张强</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 向 orders 表插入数据</span></span>
<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">orders</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">customer_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_date</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">total_amount</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-03</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">300</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-04</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">400</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-05</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">500</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-06</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">600</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-07</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">700</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-08</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">800</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-09</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">900</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),(</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-10</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1000</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- 向 order_items 表插入数据</span></span>
<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_items</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">order_id</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">product_name</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">quantity</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">price</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">VALUES</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">耐克篮球鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">阿迪达斯跑步鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">匡威帆布鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">万斯板鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">新百伦运动鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">彪马休闲鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">锐步经典鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">亚瑟士运动鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">帆布鞋</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果手写笔</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">电脑包</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果手机</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果耳机</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">        (</span><span style="color:#F78C6C;">5</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">苹果平板</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">7</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">00</span><span style="color:#A6ACCD;">);</span></span></code></pre></div><p>执行这些 sql：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-8.png" alt=""></p><p>然后查询下看看：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> customers</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-9.png" alt=""></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> orders</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-10.png" alt=""></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">select</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">from</span><span style="color:#A6ACCD;"> order_items</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-11.png" alt=""></p><p>顾客、订单、订单项三个表都成功插入了数据。</p><p>然后我们来实现下这些需求：</p><h3 id="需求-1-查询每个客户的订单总金额" tabindex="-1">需求 1: 查询每个客户的订单总金额 <a class="header-anchor" href="#需求-1-查询每个客户的订单总金额" aria-label="Permalink to &quot;需求 1: 查询每个客户的订单总金额&quot;">​</a></h3><p>客户的订单存在订单表里，可能有多个，这里需要 JOIN ON 关联两个表，然后用 GROUP BY 根据客户 id 分组，再通过 SUM 函数计算价格总和。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id;</span></span></code></pre></div><p>这里的 INNER JOIN ON 也可以简化为 JOIN ON。</p><p>执行查询：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-12.png" alt=""></p><p>成功查出了每个客户的订单总金额。</p><p>我们还可以再加上排序：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#F78C6C;">DESC</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-13.png" alt=""></p><p>如果想取前 3 的，可以用 LIMIT：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#F78C6C;">DESC</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>从第 0 个开始取 3 个：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-14.png" alt=""></p><h3 id="需求-2-查询每个客户的订单总金额-并计算其占比" tabindex="-1">需求 2: 查询每个客户的订单总金额，并计算其占比 <a class="header-anchor" href="#需求-2-查询每个客户的订单总金额-并计算其占比" aria-label="Permalink to &quot;需求 2: 查询每个客户的订单总金额，并计算其占比&quot;">​</a></h3><p>每个客户的总金额的需求上面实现了，这里需要算占比，就需要通过一个子查询来计算全部订单的总金额，然后相除：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount, </span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(orders.total_amount) </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> (</span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(total_amount) </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> orders) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">percentage</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> customers.id;</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-15.png" alt=""></p><p>当然，这里每次都算一遍总金额性能不好，可以先算出总金额，然后把数值传入。</p><p>这里只是练习子查询。</p><h3 id="需求-3-查询每个客户的订单总金额-并列出每个订单的商品清单" tabindex="-1">需求 3：查询每个客户的订单总金额，并列出每个订单的商品清单 <a class="header-anchor" href="#需求-3-查询每个客户的订单总金额-并列出每个订单的商品清单" aria-label="Permalink to &quot;需求 3：查询每个客户的订单总金额，并列出每个订单的商品清单&quot;">​</a></h3><p>这里在总金额的基础上，多了订单项的查询，需要多关联一个表：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, orders.order_date, orders.total_amount, </span></span>
<span class="line"><span style="color:#A6ACCD;">	order_items.product_name, order_items.quantity, order_items.price</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> order_items.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> customers.name, orders.order_date;</span></span></code></pre></div><p>内连接关联 3 个表，按照名字和下单日期排序。</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-16.png" alt=""></p><h3 id="需求-4-查询每个客户的订单总金额-并列出每个订单的商品清单-同时只显示客户名字姓-张-的客户的记录" tabindex="-1">需求 4：查询每个客户的订单总金额，并列出每个订单的商品清单，同时只显示客户名字姓“张”的客户的记录： <a class="header-anchor" href="#需求-4-查询每个客户的订单总金额-并列出每个订单的商品清单-同时只显示客户名字姓-张-的客户的记录" aria-label="Permalink to &quot;需求 4：查询每个客户的订单总金额，并列出每个订单的商品清单，同时只显示客户名字姓“张”的客户的记录：&quot;">​</a></h3><p>总金额和商品清单的需求前面实现了，这里只需要加一个 WHERE 来过滤客户名就行：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, orders.order_date, orders.total_amount, </span></span>
<span class="line"><span style="color:#A6ACCD;">	order_items.product_name, order_items.quantity, order_items.price</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> order_items.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> customers.name </span><span style="color:#F78C6C;">LIKE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张%</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> customers.name, orders.order_date;</span></span></code></pre></div><p>执行下：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-17.png" alt=""></p><h3 id="需求-5-查询每个客户的订单总金额-并列出每个订单的商品清单-同时只显示订单日期在2022年1月1日到2022年1月3日之间的记录" tabindex="-1">需求 5:查询每个客户的订单总金额，并列出每个订单的商品清单，同时只显示订单日期在2022年1月1日到2022年1月3日之间的记录 <a class="header-anchor" href="#需求-5-查询每个客户的订单总金额-并列出每个订单的商品清单-同时只显示订单日期在2022年1月1日到2022年1月3日之间的记录" aria-label="Permalink to &quot;需求 5:查询每个客户的订单总金额，并列出每个订单的商品清单，同时只显示订单日期在2022年1月1日到2022年1月3日之间的记录&quot;">​</a></h3><p>这里比上面的需求只是多了日期的过滤，范围是一个区间，用 BETWEEN AND：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> customers.name, orders.order_date,</span></span>
<span class="line"><span style="color:#A6ACCD;">	orders.total_amount, order_items.product_name,</span></span>
<span class="line"><span style="color:#A6ACCD;">    order_items.quantity, order_items.price</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> orders </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> customers.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> orders.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">INNER JOIN</span><span style="color:#A6ACCD;"> order_items </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> order_items.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> orders.order_date </span><span style="color:#F78C6C;">BETWEEN</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">AND</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">2022-01-03</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> customers.name, orders.order_date;</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-18.png" alt=""></p><p>因为这里的 order_date 是 date 类型，所以指定范围也只是用 2022-01-01 这种格式的。如果是 datetime，那就要用 2022-01-01 10:10:00 这种格式了。</p><h3 id="需求-6-查询每个客户的订单总金额-并计算商品数量-只包含商品名称包含-鞋-的商品-商品名用-连接-显示前-3-条记录" tabindex="-1">需求 6：查询每个客户的订单总金额，并计算商品数量，只包含商品名称包含“鞋”的商品，商品名用-连接，显示前 3 条记录： <a class="header-anchor" href="#需求-6-查询每个客户的订单总金额-并计算商品数量-只包含商品名称包含-鞋-的商品-商品名用-连接-显示前-3-条记录" aria-label="Permalink to &quot;需求 6：查询每个客户的订单总金额，并计算商品数量，只包含商品名称包含“鞋”的商品，商品名用-连接，显示前 3 条记录：&quot;">​</a></h3><p>查询订单总金额和商品数量都需要用 group by 根据 customer.id 分组，过滤出只包含鞋的商品。</p><p>把分组的多条商品名连接起来需要用 GROUP_CONCAT 函数。</p><p>然后 LIMIT 3</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        c.name </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> customer_name,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">SUM</span><span style="color:#A6ACCD;">(o.total_amount) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_amount,</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">COUNT</span><span style="color:#A6ACCD;">(oi.id) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> total_quantity,</span></span>
<span class="line"><span style="color:#A6ACCD;">        GROUP_CONCAT(oi.product_name SEPARATOR </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#F78C6C;">AS</span><span style="color:#A6ACCD;"> product_names</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers c</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> orders o </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> c.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> o.customer_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> order_items oi </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> o.id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> oi.order_id</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> oi.product_name </span><span style="color:#F78C6C;">LIKE</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%鞋%</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">GROUP BY</span><span style="color:#A6ACCD;"> c.name</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">ORDER BY</span><span style="color:#A6ACCD;"> total_amount </span><span style="color:#F78C6C;">DESC</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p>GROUP_CONCAT 函数是用于 group by 分组后，把多个值连接成一个字符串的。</p><p>LIMIT 3 就相当于 LIMIT 0,3 也就是从 0 开始 3 条记录：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-19.png" alt=""></p><h2 id="需求-7-查询存在订单的客户" tabindex="-1">需求 7: 查询存在订单的客户 <a class="header-anchor" href="#需求-7-查询存在订单的客户" aria-label="Permalink to &quot;需求 7: 查询存在订单的客户&quot;">​</a></h2><p>这里使用子查询 + EXISTS 来实现：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers c</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> orders o </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> o.customer_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c.id</span></span>
<span class="line"><span style="color:#A6ACCD;">    );</span></span></code></pre></div><p>如果从 orders 表中查出了当前 customer 的订单记录，EXISTS 就成立。</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-20.png" alt=""></p><p>当然，你也可以用 NO EXISTS 来查询没有下单过的客户：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers c</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> orders o </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> o.customer_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c.id</span></span>
<span class="line"><span style="color:#A6ACCD;">    );</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-21.png" alt=""></p><h2 id="需求-8-将王磊的订单总金额打九折" tabindex="-1">需求 8: 将王磊的订单总金额打九折 <a class="header-anchor" href="#需求-8-将王磊的订单总金额打九折" aria-label="Permalink to &quot;需求 8: 将王磊的订单总金额打九折&quot;">​</a></h2><p>现在王磊的订单总金额是这些：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> orders </span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> customers </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> orders.customer_id </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> customers.id</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> customers.name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王磊</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">;</span></span></code></pre></div><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-22.png" alt=""></p><p>更新它们为 90%：</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">UPDATE</span><span style="color:#A6ACCD;"> orders o </span><span style="color:#F78C6C;">SET</span><span style="color:#A6ACCD;"> o.total_amount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> o.total_amount </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">.</span><span style="color:#F78C6C;">9</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> o.customer_id </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> id </span><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> customers </span><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">王磊</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    );</span></span></code></pre></div><p>这里订单不止一条，所以用 IN 来指定一个集合。</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-23.png" alt=""></p><p>再查询下：</p><p><img src="//liushuaiyang.oss-cn-shanghai.aliyuncs.com/nest-docs/image/第40章-24.png" alt=""></p><p>确实减少了。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>这节我们创建了一个新的 database 并且新增了 customers、orders、order_items 表来练习 sql。</p><p>customers 和 orders、orders 和 order_items 都是一对多的关系。</p><p>我们练习了 JOIN ON、WHERE、ORDER BY、GROUP BY、LIMIT 等语法，也练习了 SUM、COUNT、GROUP_CONCAT 等函数。</p><p>还有子查询和 EXISTS。</p><p>sql 常用的语法也就这些，把这些掌握了就能完成各种需求了。</p>`,103),e=[o];function C(c,t,r,y,A,D){return a(),n("div",null,e)}const d=s(p,[["render",C]]);export{i as __pageData,d as default};
